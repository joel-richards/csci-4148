---
title: "CSCI 4148 - Practical 1"
author: "Joel Richards"
output: html_notebook
---

## Introduction

### Understanding the Data

1. Use the data dictionary describe each of the variables/features in the CSV in your report.
   a) PatientID: Unique identifier for each patient 
   b) AppointmentID: Unique identifier to each appointment 
   c) Gender: Patient Gender (limited to Male or Female)
   d) ScheduledDate: date on which the appointment was scheduled
   e) AppointmentDate: date of the actual appointment
   f) Age: Patient age
   g) Neighbourhood: District of Vitória in which the appointment 
   h) SocialWelfare: Patient is a recipient of Bolsa Família welfare payments
   i) Hypertension: Patient previously diagnoised with hypertensio (Boolean)
   j) Diabetes: Patient previously diagnosed with diabetes (Boolean)
   k) AlcoholUseDisorder: Patient previously diagnosed with alcohol use disorder (Boolean)
   l) Disability: Patient previously diagnosed with a disability (severity rated 0-4)
   m) SMSReceived: At least 1 reminder text sent before appointment (Boolean)
   n) NoShow: Patient did not attend scheduled appointment (Boolean: Yes/No)

2. Can you think of 3 hypotheses for why someone may be more likely to miss a medical appointment?
   a) Younger people will be more likely to miss an appointment.
   b) Those who have not received an SMS reminder text will be more likely to miss an appointment.
   c) Appointments scheduled well in advance of the actual appointment date will be more likely to have a no-show.

3. Can you provide 3 examples of important contextual information that is missing in this data dictionary and dataset that could impact your analyses
   a) There is no indication of the type of appointment in the dataset.
   b) The dataset does not include any information about which neighborhood the patient lives in (so as to make a comparison between their home and appointment locations).
   c) There's no data for the doctor for each appointment. This information could help determine if certain doctors have more missed appointments. This is assuming there are more than one doctor per clinic.

```{r}
library(readr)          # Data Input
library(tidymodels)     # Data Manipulation
library(lubridate)      # Data Manupulation
library(dplyr)          # Data Manipulation
library(reshape2)       # Data Manipulation
library(caTools)        # Data Manipulation
library(corrplot)       # Data Visualisation
library(ggplot2)        # Data Visualization
library(viridis)        # Data Visualization
library(ggthemes)       # Data Visualization
library(pROC)           # Metrics
library(caret)          # Machine Learning
```

## Data Parsing and Cleaning

4 Modify the following to make it reproducible i.e., downloads the data file directly from version control

```{r}
data_link <- "https://raw.githubusercontent.com/maguire-lab/health_data_science_research/master/static_files/practicals/lab1_data/2016_05v2_VitoriaAppointmentData.csv"
raw.data <- read_csv(data_link, col_types='ccfTTicllllflf')

raw.data %>% filter(Age == 0) %>% select(Hypertension, Diabetes, AlcoholUseDisorder) %>% unique()
count(raw.data, Neighbourhood, sort = TRUE)
```

5 Are there any individuals with impossible ages? If so we can drop this row using filter i.e., `data <- data %>% filter(CRITERIA)`

```{r}
raw.data <- raw.data %>% filter(Age >= 0)
```


## Exploratory Data Analysis

```{r}
count(raw.data, PatientID, sort = TRUE)
```

```{r fig.height=4, fig.width=4}
# let's define a plotting function
corplot = function(df){
  cor_matrix_raw <- round(cor(df),2)
  cor_matrix <- melt(cor_matrix_raw)
  
  
  #Get triangle of the correlation matrix
  #Lower Triangle
  get_lower_tri<-function(cor_matrix_raw){
    cor_matrix_raw[upper.tri(cor_matrix_raw)] <- NA
    return(cor_matrix_raw)
  }
  
  # Upper Triangle
  get_upper_tri <- function(cor_matrix_raw){
    cor_matrix_raw[lower.tri(cor_matrix_raw)]<- NA
    return(cor_matrix_raw)
  }
  
  
  upper_tri <- get_upper_tri(cor_matrix_raw)
  
  # Melt the correlation matrix
  cor_matrix <- melt(upper_tri, na.rm = TRUE)
  
  # Heatmap Plot
  cor_graph <- ggplot(data = cor_matrix, aes(Var2, Var1, fill = value))+
    geom_tile(color = "white")+
    scale_fill_gradient2(low = "darkorchid", high = "orangered", mid = "grey50", 
                         midpoint = 0, limit = c(-1,1), space = "Lab", 
                         name="Pearson\nCorrelation") +
    theme_minimal()+ 
    theme(axis.text.x = element_text(angle = 45, vjust = 1, 
                                     size = 8, hjust = 1))+
    coord_fixed()+ geom_text(aes(Var2, Var1, label = value), color = "black", size = 4) +
    theme(
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      panel.grid.major = element_blank(),
      panel.border = element_blank(),
      panel.background = element_blank(),
      axis.ticks = element_blank())+
      ggtitle("Correlation Heatmap")+
      theme(plot.title = element_text(hjust = 0.5))
  
  cor_graph
}

raw.data$NoShow.numeric = as.numeric(ifelse(raw.data$NoShow=="Yes",1,0))

# Find all numerical vars in dataframe
numerical.vars = sapply(raw.data, is.numeric)

# Plot Correlation Heatmap
corplot(raw.data[,numerical.vars])
```

**7 Which parameters most strongly correlate with missing appointments (NoShow)?**

A patient receiving a text message (SMSReceived) and the appointment ID correlate most strongly with the patient being a no-show.

**8 Are there any other variables which strongly correlate with one another?**

There are a few other strong correlations, such as (appointment ID and receiving a text message), (age and hypertension), (age and diabetes), and (hypertension and diabetes)

**9 Do you see any issues with PatientID/AppointmentID being included in this plot?**

The issue with including IDs in this plot is that they are unrelated to a patient in any way. Since the patient IDs are generated presumably based on the order in which a patient becomes a part of an institution and appointment IDs for ordering of appointments, they likely don't reveal actual correlations. The one exception to this could eb something like text messages, as a clinic might not have implemented the SMS messaging until after a number of these appointments occurred.

```{r}
ggplot(raw.data,aes(x=Age,fill=`NoShow`))+
  geom_density(color="white",alpha=0.8)+
  ggtitle("Density of Age across No Show")+
  scale_fill_manual(values=c("grey50","orangered"))
```

```{r fig.height=4, fig.width=6}
raw.data$Age.Range = cut(raw.data$Age,breaks = seq(0,120,10))
ggplot(raw.data,aes(x=Age.Range,y=1,fill=NoShow))+
  geom_bar(stat="identity",width=0.5)+
  ggtitle("Amount of No Show across Age Ranges")+
  scale_fill_manual(values=c("grey50","orangered"))
```

```{r fig.height=4, fig.width=6}
ggplot(raw.data,aes(x=Age.Range,y=1,fill=NoShow))+
  geom_bar(stat="identity",position="fill",width=0.5)+
  ggtitle("Proportion of No Show across Age Ranges")+
  scale_fill_manual(values=c("grey50","orangered"))
```

**10 How could you be misled if you only plotted 1 of these 2 plots of attendance by age group?**

From the first plot, we see that people older than 70 make up very few of the total appointments. When looking at only the second plot, one might assume that those groups are contributing a lot to the number of missed appointments, especially the (110, 120] cohort. However, when we look at both plots together, we can see that the actual number of missed appointments by those >= 70 years old is much smaller than the second plot makes it look.

```{r}
sum(raw.data$Age == 0)
```

```{r}
ggplot(raw.data) + 
  geom_bar(aes(x=SMSReceived, fill=NoShow), alpha=0.8) + 
  ggtitle("Density of SMS received across Age and No Show")
```

```{r}
ggplot(raw.data) + 
  geom_bar(aes(x=SMSReceived, fill=NoShow), position='fill', alpha=0.8) + 
  ggtitle("Density of SMS received across Age and No Show")
```


**11 From this plot does it look like SMS reminders increase or decrease the chance of someone not attending an appointment? Why might the opposite actually be true (hint: think about biases)?**

From the plot, it looks like SMS reminders increase the likelihood of someome not attending an appointment. However, based on the fact that far fewer older patients receive appointment reminders (but are more likely to attend an appointment), then it's likely that the SMS reminders are actually working as intended.

**12 Create a similar plot which compares the the density of NoShow across the values of disability**

```{r}
ggplot(raw.data) + 
  geom_bar(aes(x=Disability, fill=NoShow), position='fill', alpha=0.8) + 
  ggtitle("Density of SMS received across Age and No Show")
```

```{r fig.height=4, fig.width=6}
ggplot(raw.data) + 
  geom_bar(aes(x=Neighbourhood, fill=NoShow)) + 
  theme(axis.text.x = element_text(angle=45, hjust=1, size=5)) + 
  ggtitle('Attendance by Neighbourhood')
```

```{r fig.height=4, fig.width=6}
ggplot(raw.data) + 
  geom_bar(aes(x=Neighbourhood, fill=NoShow), position='fill') + 
  theme(axis.text.x = element_text(angle=45, hjust=1, size=5)) + 
  ggtitle('Proportional Attendance by Neighbourhood')
```

**13 Suggest a reason for differences in attendance rates across neighbourhoods.**

The age demographics of each neighborhood could be very similar to the others. Something like a population pyramid would help make this comparison.

```{r}
ggplot(raw.data) + 
  geom_bar(aes(x=Gender, fill=NoShow)) +
  ggtitle("Gender by attendance")
```

```{r}
ggplot(raw.data) + 
  geom_bar(aes(x=Gender, fill=NoShow), position='fill') + 
  ggtitle("Gender by Attendance")
```

**14 Create a similar plot using SocialWelfare**

```{r}
ggplot(raw.data) +
  geom_bar(aes(x=SocialWelfare, fill=NoShow), position='fill') + 
  ggtitle("Welfare Usage by Attendance")
```

## Feature Engineering

```{r}
raw.data <- raw.data %>% mutate(AppointmentDay = wday(AppointmentDate, label=TRUE, abbr=TRUE), 
                                 ScheduledDay = wday(ScheduledDate,  label=TRUE, abbr=TRUE))

ggplot(raw.data) +
  geom_bar(aes(x=AppointmentDay, fill=NoShow)) +
  ggtitle("Amount of No Show across Appointment Day") 
```

```{r}
ggplot(raw.data) +
  geom_bar(aes(x=AppointmentDay, fill=NoShow), position = 'fill') +
  ggtitle("Amount of No Show across Appointment Day") 
```

```{r}
raw.data <- raw.data %>% mutate(Lag.days=difftime(AppointmentDate, ScheduledDate, units = "days"),
                                Lag.hours=difftime(AppointmentDate, ScheduledDate, units = "hours"))

ggplot(raw.data) + 
  geom_density(aes(x=Lag.days, fill=NoShow), alpha=0.7)+
  ggtitle("Density of Lag (days) by attendance")
```

**15 Have a look at the values in lag variable, does anything seem odd?**

There is a massive spike in appointments with next to no lag time between scheduling an appointment and the date of the appointment. It seems as though a very large portion of appointments are booked last-minute. This could be due to the clinics trying to fill in appointments that were cancelled at the last minute. Alternatively, the clinics could have a long wait line for walk-in appointments, which would explain so many appointments occurring with no lead time.

## Predictive Modeling

```{r}
data.prep = raw.data %>% select(Gender, Lag, Age, ScheduledDay, 
                                AppointmentDay, Neighbourhood, SocialWelfare,
                                Hypertension, Diabetes, NoShow,
                                AlcoholUseDisorder, Disability, SMSReceived) %>%
                          mutate(Gender = as.factor(Gender),
                                 NoShow = as.factor(NoShow),
                                 Neighbourhood = as.factor(Neighbourhood))
set.seed(41)
splitr = sample.split(data.prep$NoShow, SplitRatio = 0.7)
train  = subset(data.prep,splitr == TRUE)
test   = subset(data.prep,splitr == FALSE)
```

```{r}
fit.control <- trainControl(method="cv",number=3,
                           classProbs = TRUE, summaryFunction = twoClassSummary)
```

**16 Based on the EDA, how well do you think this is going to work?**

...

```{r}
xgb.grid <- expand.grid(eta=c(0.05),
                       max_depth=c(4),colsample_bytree=1,
                       subsample=1, nrounds=500, gamma=0, min_child_weight=5)

xgb.model <- train(NoShow ~ .,data=train, method="xgbTree",metric="ROC",
                  tuneGrid=xgb.grid, trControl=fit.control)

xgb.pred <- predict(xgb.model, newdata=test)
xgb.probs <- predict(xgb.model, newdata=test, type="prob")
```

```{r}
test <- test %>% mutate(NoShow.numerical = ifelse(NoShow=="Yes",1,0))
confusionMatrix(xgb.pred, test$NoShow, positive="Yes")
```

```{r}
paste("XGBoost Area under ROC Curve: ", round(auc(test$NoShow.numerical, xgb.probs[,2]),3), sep="")
```

```{r}
xgb.probs$Actual = test$NoShow.numerical
xgb.probs$ActualClass = test$NoShow
xgb.probs$PredictedClass = xgb.pred
xgb.probs$Match = ifelse(xgb.probs$ActualClass == xgb.probs$PredictedClass,
                         "Correct","Incorrect")
# [4.8] Plot Accuracy
xgb.probs$Match = factor(xgb.probs$Match,levels=c("Incorrect","Correct"))
ggplot(xgb.probs,aes(x=Yes,y=Actual,color=Match))+
  geom_jitter(alpha=0.2,size=0.25)+
  scale_color_manual(values=c("grey40","orangered"))+
  ggtitle("Visualizing Model Performance", "(Dust Plot)")
```

```{r}
results = data.frame(Feature = rownames(varImp(xgb.model)$importance)[1:10],
                     Importance = varImp(xgb.model)$importance[1:10,])

results$Feature = factor(results$Feature,levels=results$Feature)


# [4.10] Plot Variable Importance
ggplot(results, aes(x=Feature, y=Importance,fill=Importance))+
  geom_bar(stat="identity")+
  scale_fill_gradient(low="grey20",high="orangered")+
  ggtitle("XGBoost Variable Importance")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

**17 Using the caret package fit and evaluate 1 other ML model on this data.**

**18 Based on everything, do you think we can trust analyses based on this dataset? Explain your reasoning.**
